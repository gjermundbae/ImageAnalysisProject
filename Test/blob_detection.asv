%% Load sample frames

%load sampleFrames.mat
subplot(1,4,1)
img = imread("142.jpg");
imshow(img)
size(img)

%% Threshold image

% Convert RGB image to chosen color space
I = rgb2hsv(img);

% Define thresholds for channel 1 based on histogram settings
channel1Min = 0.000;
channel1Max = 1.000;

% Define thresholds for channel 2 based on histogram settings
channel2Min = 0.000;
channel2Max = 1.000;

% Define thresholds for channel 3 based on histogram settings
channel3Min = 0.000;
channel3Max = 0.164;

% Create mask based on chosen histogram thresholds
sliderBW = (I(:,:,1) >= channel1Min ) & (I(:,:,1) <= channel1Max) & ...
    (I(:,:,2) >= channel2Min ) & (I(:,:,2) <= channel2Max) & ...
    (I(:,:,3) >= channel3Min ) & (I(:,:,3) <= channel3Max);
BW = sliderBW;

subplot(1,4,2)
imshow(BW);

%% Remove disturbances
%Create structural element
diskElem = strel('disk',1);
Ibwclose = imclose(BW,diskElem);
Ibwopen = imopen(BW,diskElem);
subplot(1,4,3)
imshow(Ibwopen);
subplot(1,4,4)
imshow(Ibwclose);
%% Blob analysis


hBlobAnalysis = vision.BlobAnalysis('MinimumBlobArea',8,...
    'MaximumBlobArea',10); %
[objArea, objCentroid, bboxOut] = step(hBlobAnalysis, Ibwopen);

%% Annotate image




Ishape = insertShape(img, 'rectangle',bboxOut,'LineWidth',2);
figure
subplot(1,2,1)
imshow(Ishape);

numObj = numel(objArea);
%hTextIns = insertText('%d', 'Location',[20,20],'Color',...
%    [255 255 0], 'FontSize', 30);
Itext = insertText(Ishape, [20,20], int32(numObj),'FontSize', 40);

subplot(1,2,2)
imshow(Itext);

%% Clean up

release(hBlobAnalysis)

%% Loop

%% Setup
% Create object to read video frames from the video file

vidReader = vision.VideoFileReader();
vidReader.VideoOutputDataType = 'double';

%Create structural element for morphological operations to remove
%disturbances
diskElem = strel('disk',2);

hBlobAnalysis = vision.BlobAnalysis('MinimumBlobArea',8,...
    'MaximumBlobArea',10); %
[objArea, objCentroid, bboxOut] = step(hBlobAnalysis, Ibwopen);

%% Alg in loop
while ~isDone(vidReader)

    %Read Frame
    vidFrame = step(vidReader);

    %Convert RGB image to chosen color space
    Ihsv = rgb2hsv(vidFrame);

    % Define thresholds for channel 1 based on histogram settings
    channel1Min = 0.000;
    channel1Max = 1.000;
    
    % Define thresholds for channel 2 based on histogram settings
    channel2Min = 0.000;
    channel2Max = 1.000;
    
    % Define thresholds for channel 3 based on histogram settings
    channel3Min = 0.000;
    channel3Max = 0.164;
    
    % Create mask based on chosen histogram thresholds
    Ibw = (I(:,:,1) >= channel1Min ) & (I(:,:,1) <= channel1Max) & ...
        (I(:,:,2) >= channel2Min ) & (I(:,:,2) <= channel2Max) & ...
        (I(:,:,3) >= channel3Min ) & (I(:,:,3) <= channel3Max);
    %BW = sliderBW;


    % Use morphological operations to remove disturbances
    Ibwopen = imopen(Ibw, diskElem);

    % Extract blobs from the frame
    [objArea, objCentroid, bboxOut] = step(hBlobAnalysis, Ibwopen);

    % Insert a string of number of objects detected in the video frame
    numObj = length(areaOut);

    % Draw box around detected objects and insert text
    Ishape = insertShape(vidFrame, 'rectangle',bboxOut,'LineWidth',2);
    Ishape_text = insertText(Ishape, [20,20], int32(numObj),'FontSize', 40);

    step(vidPlayer, Ishape_text);

end

%% Cleanup
release(vidReader)
release(hB)


